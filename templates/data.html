<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <script src="//d3js.org/d3.v4.min.js"></script>

  <style>
      * {
        font-family: 'Open Sans', sans-serif;
      }

      body {
        height: 100%;
        margin: 0;
        text-align: center;
      }

      .axisBottom line {
        stroke: #c4c4c4;
        stroke-width: 1;
      }

      .axisBottom text {
        fill: black;
        font-weight: 200;
      }

      .axisBottom path {
        stroke: #c4c4c4;
        stroke-width: 1;
      }

      .axisLeft line {
        stroke: #c4c4c4;
        stroke-width: 1;
      }

      .axisLeft text {
        fill: black;
        font-weight: 200;
      }

      .axisLeft path {
        stroke: #c4c4c4;
        stroke-width: 1;
      }

      #page_row {
        margin-top: 10px;
      }

      #select_container {
        border-radius: 5px;
        background: #dddddd;
        padding: 20px; 
        width: 100%;
        height: 100%; 
        text-align: left;
      }

      #select_container p {
        margin-bottom: 5px;
      }

      @media only screen and (max-width: 767px) {
        #graph_row {
          margin-top: 25px;
        }
      }

      #graph_container {
        border-radius: 5px;
        background: #dddddd;
        padding: 20px;
        width: 100%;
        height: 100%; 
      }

      #about_row {
        margin-top: 25px;
      }

      #about_container {
        border-radius: 5px;
        background: #dddddd;
        padding-top: 20px; 
        padding-right: 20px; 
        padding-left: 20px; 
        margin-bottom: 20px;
        width: 100%;
        height: 100%; 
        text-align: center;
      }

      #about_text {
        text-align: left;
      }

      #wrapper {
        min-height: calc(100vh - 65px);
      }

      #push {
        height: 50px;
      }

      footer {
        background: #2b2c28;
        width: 100%;
        height: 50px;
        text-align: left;
        font-weight: 200;
      }

      #footer_text {
        margin-top: 15px;
        color: white;
        padding: 10px;
      }

  </style>
</head>
<body>

<div id="wrapper">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Laundry@UVA</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
            <a class="nav-item nav-link" href="https://github.com/hmir/laundry-traffic" target="_blank"> Source Code </a>
            <a class="nav-item nav-link" href="https://www.dropbox.com/sh/y6e80ckxausjees/AAAhi-p47vjPH3_c8teUYk5ha?dl=0" target="_blank"> Raw Data </a>
            <a class="nav-item nav-link" href="https://hamzamir.com" target="_blank"> About the Developer</a>
        </div>
      </div>
  </nav>
  <div id="page_container" class="container-fluid">
    <div id="page_row" class="row">
      <div id="select_row" class="col-md-4 col-xs-12">
        <div id=select_container>
            <p> Building </p>
            <select id="buildingSelect" class="custom-select" style="margin-bottom: 15px">
              <option value="Balz-Dobie">Balz-Dobie</option>
              <option value="BiceHouse">Bice House</option>
              <option value="BrownCollege">Brown College</option>
              <option value="Dabney">Dabney</option>
              <option value="Dillard">Dillard</option>
              <option value="Cauthen">Cauthen</option>
              <option value="CopeleyBldg829">Copeley Bldg 829</option>
              <option value="CopeleyBldg833">Copeley Bldg 833</option>
              <option value="CopeleyBldg836">Copeley Bldg 836</option>
              <option value="CopeleyBldg839">Copeley Bldg 839</option>
              <option value="EastLawn">East Lawn</option>
              <option value="FaulknerApartments">Faulkner Apartments</option>
              <option value="FrenchHouse">French House</option>
              <option value="GibbonsHouse">Gibbons House</option>
              <option value="Gooch">Gooch</option>
              <option value="Gwathmey">Gwathmey</option>
              <option value="HerefordCollege(Runk)">Hereford College (Runk)</option>
              <option value="Kellogg">Kellogg</option>
              <option value="Lambeth">Lambeth</option>
              <option value="Lewis">Lewis</option>
              <option value="Lile-Maupin">Lile-Maupin</option>
              <option value="Metcalf">Metcalf</option>
              <option value="Munford">Munford</option>
              <option value="ShannonHouse">Shannon House</option>
              <option value="SheaHouse">Shea House</option>
              <option value="SpanishHouse">Spanish House</option>
              <option value="Tuttle-Dunnington">Tuttle-Dunnington</option>
              <option value="Watson-Webb">Watson-Webb</option>
            </select>
          
            <p> Day </p>
            <select id="daySelect" class="custom-select" style="margin-bottom: 15px">
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
              <option value="Sunday">Sunday</option>
            </select>
          
            <p> Machine </p>
            <select id="machineSelect" class="custom-select">
              <option value="washers">Washers</option>
              <option value="dryers">Dryers</option>
            </select>
          
            <br>
            <br>
            <button id="go_button" type="button" class="btn btn-primary" style="width: 100%">Go</button>
        </div>
      </div>
      <div id="graph_row" class="col-md-8 col-xs-12">
        <div id="graph_container">
          <div id="graph">
            <script>
            function generateGraph(graphWidth) {
              // remove any existing graphs
              $("svg").remove();

              // make object keys hourly instead of every 5 minutes
              rawData = {{machineData|tojson|safe}};
              tempRawData = {};
              tempRawCount = {};
              for(key in rawData) {
                hour = key.substring(0,2)
                tempRawData[hour] = (tempRawData[hour] + rawData[key]) || rawData[key]
                tempRawCount[hour] = (tempRawCount[hour] + 1) || 1
              }
              
              for(key in tempRawData) {
                tempRawData[key] = tempRawData[key]/tempRawCount[key]
              }
              
              rawData = tempRawData
              
              // set the dimensions and margins of the graph
              var margin = {top: 20, right: 50, bottom: 50, left: 50},
                  width = graphWidth - margin.left - margin.right,
                  height = graphWidth * 3.0/7.0 - margin.top - margin.bottom;
              
              // set the ranges
              var x = d3.scaleBand()
                        .range([0, width])
                        .padding(0.1);
              var y = d3.scaleLinear()
                        .range([height, 0]);
              
              var color = "steelblue";
              
              // append the svg object to the body of the page
              // append a 'group' element to 'svg'
              // moves the 'group' element to the top left margin
              var svg = d3.select("#graph").append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .attr("id", "graph")
                .append("g")
                  .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");
              
              data = []
              for(key in rawData) {
                data.push({'time':key, 'value':rawData[key] * 100});
              }
              
              String.prototype.hashCode = function() {
                var hash = 0, i, chr;
                if (this.length === 0) return hash;
                for (i = 0; i < this.length; i++) {
                  chr   = this.charCodeAt(i);
                  hash  = ((hash << 5) - hash) + chr;
                  hash |= 0;
                }
                return hash;
              };
              
              data.sort(function(a, b){
                  return a.time.hashCode() - b.time.hashCode();
              });
              
              x.domain(data.map(function(d) { return d.time; }));
              y.domain([0, 100]); // d3.max(data, function(d) { return d.value; })]);
              
              var yMax = d3.max(data, function(d){return d.value});
              var yMin = d3.min(data, function(d){return d.value});
              var colorScale = d3.scaleLinear()
                          .domain([yMin, yMax])
                          .range([d3.rgb(color).brighter(), d3.rgb(color).darker()]);
              
              // append the rectangles for the bar chart
              svg.selectAll(".bar")
                  .data(data)
                .enter().append("rect")
                  .attr("class", "bar")
                  .attr("x", function(d) { return x(d.time); })
                  .attr("width", x.bandwidth())
                  .attr("y", function(d) { return y(d.value); })
                  .attr("height", function(d) { return height - y(d.value); })
                  .attr("fill", function(d) { return colorScale(d.value) });
              
              // add the x Axis
              svg.append("g")
                  .attr("transform", "translate(0," + height + ")")
                  .attr("class", "axisBottom")
                  .call(d3.axisBottom(x));
              
              // x axis label
              svg.append("text")
                  .attr("transform",
                        "translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
                  .style("text-anchor", "middle")
                  .style("font-weight", "200")
                  .style("font-size", "20")
                  .style("fill", "black")
                  .text("Time");
              
              // add the y Axis
              svg.append("g")
                  .attr("class", "axisLeft")
                  .call(d3.axisLeft(y));
              
              // y axis label
              svg.append("text")
                  .attr("transform", "rotate(-90)")
                  .attr("y", 0 - margin.left)
                  .attr("x",0 - (height / 2) - 10)
                  .attr("dy", "1em")
                  .style("text-anchor", "middle")
                  .style("font-weight", "200")
                  .style("font-size", "20")
                  .style("fill", "black")
                  .text("Percent Used");
            }   
            </script>
          </div>
        </div>
      </div>
    </div>
    <div id="about_row" class="row">
      <div id="about_col" class="col-xs-12 col-md-12">
        <div id="about_container">
          <div id="about_text">
            <h1> About </h1>
            <p> This data was collected between January 24th to February 17th of 2018 from <a href="http://www.virginia.edu/cavalieradvantage"> Cavalier Advantage </a> 
            at an interval of every 5 minutes. Each bar in the graph represents the average percentage of machines used from to start of the given hour to the end. </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div id="footer_text">© 2018 Copyright:
    <a href="https://hamzamir.com"> hamzamir.com</a>
  </div>

</footer>

<script>

  var url = new URL(window.location.href);
  $('#buildingSelect').val(url.searchParams.get('building'));
  $('#daySelect').val(url.searchParams.get('day'));
  $('#machineSelect').val(url.searchParams.get('machine'));

  $('#go_button').on('click', () => {
    var building = $('#buildingSelect').val();
    var day = $('#daySelect').val();
    var machine = $('#machineSelect').val();

    url.searchParams.set('building', building);
    url.searchParams.set('day', day);
    url.searchParams.set('machine', machine);

    window.location.href = url.href;
  });

  window.lastWidth = window.innerWidth;

  function getGraphSize(windowSize) {
    if(windowSize > 1100) {
      return 700;
    }
    else if(windowSize > 930) {
      return 600;
    }
    else if(windowSize > 515) {
      return 500;
    }
    else if(windowSize > 415) {
      return 400;
    }
    else {
      return 360;
    }
  }

  $(window).resize(function() {
     if(getGraphSize(window.innerWidth) != getGraphSize(window.lastWidth)) {
       generateGraph(getGraphSize(window.innerWidth));
       window.lastWidth = window.width;
     }
  });
  generateGraph(getGraphSize(window.innerWidth));
</script>

</body>
</html>
